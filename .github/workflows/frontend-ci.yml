name: Frontend CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------
      # 0. SETUP ENVIRONMENT AND CHECKOUT CODE
      # -----------------------------------------------------------------
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: linkhub-app/package-lock.json

      # -----------------------------------------------------------------
      # 1. GENERATE COVERAGE FOR THE PULL REQUEST
      # -----------------------------------------------------------------
      - name: Install dependencies (PR)
        run: npm ci
        working-directory: ./linkhub-app

      - name: Run Linter (PR)
        run: npm run lint
        working-directory: ./linkhub-app

      - name: Run Build
        run: npm run build
        working-directory: ./linkhub-app

      - name: Run Tests with Coverage (PR)
        run: npx vitest run --coverage
        working-directory: ./linkhub-app

      - name: Move PR coverage reports
        run: |
          mv linkhub-app/coverage/coverage-summary.json ./pr-summary.json
          mv linkhub-app/coverage/coverage-final.json ./pr-final.json

      # -----------------------------------------------------------------
      # 2. GENERATE COVERAGE FOR THE 'main' BRANCH
      # -----------------------------------------------------------------
      - name: Switch to 'main' branch
        run: |
          git fetch origin main
          git checkout origin/main --force

      - name: Install dependencies (main)
        run: npm ci
        working-directory: ./linkhub-app

      - name: Run Coverage (main)
        run: npx vitest run --coverage
        working-directory: ./linkhub-app

      - name: Move main coverage summary report
        run: mv linkhub-app/coverage/coverage-summary.json ./main-summary.json

      # -----------------------------------------------------------------
      # 3. POST THE COMPARISON COMMENT
      # -----------------------------------------------------------------
      - name: Post Coverage Comment
        if: always()
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          name: Frontend Test Coverage Report
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vite-config-path: ./linkhub-app/vite.config.ts
          json-summary-path: ./pr-summary.json
          json-final-path: ./pr-final.json
          json-summary-compare-path: ./main-summary.json

      # -----------------------------------------------------------------
      # 4. UPLOAD COVERAGE TO CODECOV
      # -----------------------------------------------------------------
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./pr-final.json
          flags: frontend
          name: Frontend CI Coverage
          fail_ci_if_error: false
          verbose: true
