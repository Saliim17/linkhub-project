name: Full Issue/PR Triage

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited]

jobs:
  triage-item:
    name: Triage New Issue/PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Auto Label
        uses: github/issue-labeler@v3.4
        with:
          configuration-path: .github/labeler.yml
          enable-versioned-regex: 0
          repo-token: ${{ secrets.PROJECT_PAT }}
          include-title: true
          sync-labels: true

      - name: Add to Project
        if: github.event_name == 'issues'
        uses: actions/add-to-project@v1.0.1
        with:
          project-url: "https://github.com/users/Saliim17/projects/3"
          github-token: ${{ secrets.PROJECT_PAT }}

      - name: Assign and Add Milestone
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const MILESTONE_TITLE = "v1.0: Frontend App";
            const { owner, repo } = context.repo;
            
            const updatePayload = {
              owner,
              repo,
              issue_number: context.issue.number,
              assignees: [context.actor]
            };
            
            const milestones = await github.rest.issues.listMilestones({ owner, repo });
            const targetMilestone = milestones.data.find(m => m.title === MILESTONE_TITLE);
            
            if (!targetMilestone) {
              console.log(`Milestone "${MILESTONE_TITLE}" not found. Skipping milestone assignment.`);
            } else {
              console.log(`Assigning to milestone: ${targetMilestone.title} (ID: ${targetMilestone.number})`);
              updatePayload.milestone = targetMilestone.number;
            }
            
            // 3. Ejecuta la actualizaci√≥n con el payload final
            await github.rest.issues.update(updatePayload);